# docker-compose.yml
version: '3.8'

services:
  # FastAPI Application
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rag-pipeline-api
    ports:
      - "8000:8000"
    volumes:
      - ./app:/app/app
      - ./data:/app/data
      - model-cache:/app/transformers_models
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - DATABASE_PATH=/app/data/rag_data.db
      - CHROMA_PERSIST_DIR=/app/data/chroma_langchain_db
      - TRANSFORMERS_CACHE=/app/transformers_models
      - QDRANT_URL=http://qdrant:6333
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis
      - qdrant
    networks:
      - rag-network
    restart: unless-stopped

  # Redis for caching and task queue
  redis:
    image: redis:7-alpine
    container_name: rag-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - rag-network
    restart: unless-stopped

  # Qdrant vector database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: rag-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - rag-network
    restart: unless-stopped

  # Optional: Celery worker for distributed task processing
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rag-celery-worker
    command: celery -A app.celery_app worker --loglevel=info
    volumes:
      - ./app:/app/app
      - ./data:/app/data
      - model-cache:/app/transformers_models
    environment:
      - DATABASE_PATH=/app/data/rag_data.db
      - CHROMA_PERSIST_DIR=/app/data/chroma_langchain_db
      - TRANSFORMERS_CACHE=/app/transformers_models
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis
      - qdrant
    networks:
      - rag-network
    restart: unless-stopped

  # Optional: Nginx for production
  nginx:
    image: nginx:alpine
    container_name: rag-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend/dist:/usr/share/nginx/html:ro
    depends_on:
      - api
    networks:
      - rag-network
    restart: unless-stopped

volumes:
  redis-data:
  qdrant-data:
  model-cache:

networks:
  rag-network:
    driver: bridge

---
# Dockerfile
FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY ./app /app/app
COPY .env /app/.env

# Create directories
RUN mkdir -p /app/data /app/transformers_models

# Expose port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8000/ || exit 1

# Run application
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]

---
# Dockerfile.dev (для разработки с hot-reload)
FROM python:3.11-slim

WORKDIR /app

RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install development dependencies
RUN pip install --no-cache-dir pytest pytest-asyncio black flake8

COPY ./app /app/app
COPY .env /app/.env

RUN mkdir -p /app/data /app/transformers_models

EXPOSE 8000

# Run with hot-reload
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

---
# nginx.conf (для production)
events {
    worker_connections 1024;
}

http {
    upstream api {
        server api:8000;
    }

    server {
        listen 80;
        server_name _;

        # Frontend
        location / {
            root /usr/share/nginx/html;
            try_files $uri $uri/ /index.html;
        }

        # API proxy
        location /api/ {
            proxy_pass http://api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # File upload size
        client_max_body_size 100M;
    }
}

---
# .dockerignore
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
.venv/
.env
data/
transformers_models/
*.db
*.log
.git/
.gitignore
README.md
tests/
.pytest_cache/
.coverage
htmlcov/
dist/
build/
*.egg-info/

---
# Makefile для удобства
.PHONY: help build up down logs shell test clean

help:
	@echo "Available commands:"
	@echo "  make build    - Build Docker images"
	@echo "  make up       - Start all services"
	@echo "  make down     - Stop all services"
	@echo "  make logs     - View logs"
	@echo "  make shell    - Open shell in API container"
	@echo "  make test     - Run tests"
	@echo "  make clean    - Clean volumes and data"

build:
	docker-compose build

up:
	docker-compose up -d

down:
	docker-compose down

logs:
	docker-compose logs -f

shell:
	docker-compose exec api /bin/bash

test:
	docker-compose exec api pytest tests/

clean:
	docker-compose down -v
	rm -rf data/chroma_langchain_db/*
	rm -rf data/*.db

dev:
	docker-compose -f docker-compose.dev.yml up

prod:
	docker-compose -f docker-compose.prod.yml up -d

---
# docker-compose.dev.yml (для разработки)
version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: rag-pipeline-api-dev
    ports:
      - "8000:8000"
    volumes:
      - ./app:/app/app:delegated
      - ./data:/app/data
      - model-cache:/app/transformers_models
    environment:
      - DEBUG=True
      - API_HOST=0.0.0.0
      - API_PORT=8000
    depends_on:
      - redis
      - qdrant
    networks:
      - rag-network

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - rag-network

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - rag-network

volumes:
  qdrant-data:
  model-cache:

networks:
  rag-network:
    driver: bridge